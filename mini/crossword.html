<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Hangul Crossword NYT-style</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif;
      padding: 40px;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(5, 48px);
      gap: 6px;
    }

    .cell {
      width: 48px;
      height: 48px;
      text-align: center;
      font-size: 22px;
      border: 1px solid #444;
    }

    .cell:focus {
      outline: 2px solid #2563eb;
    }
  </style>
</head>
<body>

<h1>NYT-style 한글 입력</h1>

<div id="grid">
  <input class="cell" />
  <input class="cell" />
  <input class="cell" />
  <input class="cell" />
  <input class="cell" />
</div>

<script>
  const cells = Array.from(document.querySelectorAll(".cell"));
  let isComposing = false;

  cells.forEach(cell => {
    cell.setAttribute("maxlength", "3"); // 조합 대비
    cell.setAttribute("autocomplete", "off");
    cell._prevValue = "";
  });

  function getNextCell(i) {
    return cells[i + 1] ?? null;
  }

  function focusCell(cell) {
    if (cell) cell.focus();
  }

  function commonPrefix(a, b) {
    let i = 0;
    while (i < a.length && i < b.length && a[i] === b[i]) i++;
    return a.slice(0, i);
  }

  cells.forEach((cell, index) => {

    cell.addEventListener("compositionstart", () => {
      isComposing = true;
      cell._prevValue = cell.value;
    });

    cell.addEventListener("compositionupdate", (e) => {
      const prev = cell._prevValue;
      const curr = e.target.value;

      // 핵심 케이스: "간" → "가나"
      if (prev.length === 1 && curr.length === 2) {
        const prefix = commonPrefix(prev, curr);
        const rest = curr.slice(prefix.length);

        if (prefix.length === 1 && rest.length === 1) {
          cell.value = prefix;

          const next = getNextCell(index);
          if (next) {
            next.value = rest;
            next._prevValue = rest;
            focusCell(next);
          }
        }
      }

      cell._prevValue = e.target.value;
    });

    cell.addEventListener("compositionend", (e) => {
      isComposing = false;
      cell._prevValue = "";
    });

    cell.addEventListener("keydown", (e) => {
      if (isComposing) return;

      if (e.key === "Backspace") {
        if (cell.value === "") {
          const prev = cells[index - 1];
          if (prev) {
            prev.value = "";
            focusCell(prev);
          }
        } else {
          cell.value = "";
        }
        e.preventDefault();
      }
    });
  });
</script>

</body>
</html>
